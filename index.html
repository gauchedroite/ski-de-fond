<!DOCTYPE HTML>
<html manifest="manifest.appcache">
<head>

<meta charset="utf-8">
<title>Les conditions</title>
<link rel="icon" href="data:;base64,iVBORw0KGgo=">

<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no, minimal-ui">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<link rel="apple-touch-icon" href="images/icon-114x114.png" sizes="57x57" />
<link rel="apple-touch-icon" href="images/icon-114x114.png" sizes="114x114" />
<link rel="apple-touch-icon" href="images/icon-144x144.png" sizes="72x72" />
<link rel="apple-touch-icon" href="images/icon-144x144.png" sizes="144x144" />

<link rel="apple-touch-startup-image" media="(device-width: 320px)" href="images/startup-image-320x460.png" />
<link rel="apple-touch-startup-image" media="(device-width: 320px) and (-webkit-device-pixel-ratio: 2)" href="images/startup-image-640x920.png" />

<link rel="stylesheet" href="css/styles.css" />

<script src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script src="scripts/soleil.js"></script>

<script type="text/javascript">
var google = {};
google.visualization = {};
google.visualization.Query = {};

var month_names = [ 'janvier', 'février', 'mars', 'avril', 'mai', 'juin', 'juillet', 'août', 'septembre', 'octobre', 'novembre', 'décembre' ];
var periodes = [ '', 'Ce soir', 'Cette nuit', 'Ce matin', 'Cet après-midi' ];
var updatedDate;

$(document).ready(function() {
    google.visualization.Query.setResponse = parseSpreadsheetData_First;
    var url = "https://spreadsheets.google.com/tq?key=0AqeNjAYIAcUedGl0SWVZZzNtQ0JNTVFuR1dRQ3psMlE&pub=1&gid=6";
    var script = document.createElement("script");        
    script.setAttribute("src", url);
    script.setAttribute("type", "text/javascript");                
    document.body.appendChild(script);

    var url2 = "https://www.meteomedia.com/dataaccess/citypage/json/caqc0177?callback=parseCitypageData&t=" + new Date().getTime();
    var script2 = document.createElement("script");        
    script2.setAttribute("src", url2);
    script2.setAttribute("type", "text/javascript");                
    document.body.appendChild(script2);

    var timezone = new Date().getTimezoneOffset() / 60;
    var sun = computeSunrise(new Date(), 45.5, 75.5);
    $('#lever-coucher-text').text(formatSunTime(sun.sunriseGMT - timezone) + " - " + formatSunTime(sun.sunsetGMT - timezone));
    $('#semaine-text').text(formatSunDelta(sun.semaine));
});

function parseSpreadsheetData_First(response) {
    updatedDate = response.table.rows[0].c[1].v;

    google.visualization.Query.setResponse = parseSpreadsheetData_Second;
    var url = "https://spreadsheets.google.com/tq?key=0AqeNjAYIAcUedGl0SWVZZzNtQ0JNTVFuR1dRQ3psMlE&pub=1&gid=4";
    var script = document.createElement("script");        
    script.setAttribute("src", url);
    script.setAttribute("type", "text/javascript");                
    document.body.appendChild(script);
}

function parseSpreadsheetData_Second(response) {
    var cols = response.table.cols;
    var rows = response.table.rows;
    var updatedTime = rows[7].c[2].v;
    var snow = cols[2].label;
    var wax = rows[3].c[2].v;
    var new24 = rows[4].c[2].v;
    var p8 = rows[5].c[2].v;

    $('#updated-text').text(formatUpdated(updatedDate));
    $('#updated-text-2').text("Il y a " + formatElapsed(updatedDate));
    $('#wax-text').text(formatWax(wax));
    $('#snow-text').html(formatSnow(snow));
    $('#p8-text').text(formatP8(p8));
    $('#new24-text').text(formatNew24(new24));
}

function parseCitypageData(response) {
    var obs = response.PACKAGE.Observation;
    $('#obs-text').html(obs.temperature_c + "&deg;C (" + obs.feelsLike_c + "&deg;C) " + obs.windSpeed_kmh + " km/h");
    var pa = response.PACKAGE.ShortTerm.Period[0];
    $('#forecast-a-text').html(
        periodes[pa.period] + ": " +
        pa.temperature_c + ' &deg;C (' + pa.feelsLike_c + '&deg;C) ' +
        pa.windSpeed_kmh + ' km/h ' +
        pa.pop_percent + '% ' +
        (pa.rain > 0 ? pa.rain_range + ' mm pluie' : '') + (pa.rain > 0 && pa.snow > 0 ? ', ' : '') + (pa.snow > 0 ? pa.snow_range + ' cm neige' : '')
    );
    pa = response.PACKAGE.ShortTerm.Period[1];
    $('#forecast-b-text').html(
        periodes[pa.period] + ": " +
        pa.temperature_c + ' &deg;C (' + pa.feelsLike_c + '&deg;C) ' +
        pa.windSpeed_kmh + ' km/h ' +
        pa.pop_percent + '% ' +
        (pa.rain > 0 ? pa.rain_range + ' mm pluie' : '') + (pa.rain > 0 && pa.snow > 0 ? ', ' : '') + (pa.snow > 0 ? pa.snow_range + ' cm neige' : '')
    );
}

function formatUpdated(updated) {
    var date = new Date(updated);
    var yyyy = date.getFullYear();
    var mo = month_names[date.getMonth()];
    var dd = date.getDate();
    var hh = date.getHours();
    var mm = date.getMinutes();
    return dd + ' ' + mo + ' à ' + hh + 'h' + (mm < 10 ? '0' : '') + mm;
}

function formatElapsed(updated) {
    var diff = new Date().getTime() - new Date(updated).getTime();
    var days = Math.floor(diff / 1000 / 60 / 60 / 24);
    diff -= days * 1000 * 60 * 60 * 24;
    var hours = Math.floor(diff / 1000 / 60 / 60);
    diff -= hours * 1000 * 60 * 60;
    var mins = Math.floor(diff / 1000 / 60);
    diff -= mins * 1000 * 60;
    return (days > 0 ? days + ' jour' : '') + (days > 1 ? 's' : '') + ' ' +
        (hours > 0 ? hours + ' heure' : '') + (hours > 1 ? 's' : '') + ' ' +
        (mins + ' minute') + (mins > 1 ? 's' : '');
}

function formatSunTime(hour) {
    var h = Math.floor(hour);
    var m = Math.floor(60 * (hour - h));
    return h + 'h' + (m < 10 ? '0' : '') + m;
}

function formatSunDelta(hour) {
    var negative = (hour < 0);
    if (negative) hour = -hour;

    var h = Math.floor(hour);
    var m = Math.floor(60 * (hour - h));
    var s = Math.floor(3600 * (hour - h - m / 60));
    return (negative ? "Perte" : "Gain") + " de " + m + " minutes " + s + " secondes d'ensoleillement cette semaine";
}

function formatWax(wax) {
    if (wax == null) return '??';
    var parts = wax.split('/');
    return parts[0].trim();
}

function formatSnow(snow) {
    if (snow == null) return '??';
    if (snow == "N/A") return "";
    return "La neige est à " + snow + " &deg;C";
}

function formatP8(p8) {
    if (p8 == null) return "??";
    if (p8 == "N/A") return "--";
    return p8;
}

function formatNew24(new24) {
    if (new24 == null) return "??";
    return new24 + " de nouvelle neige dans les dernières 24 heures";
}
</script>
</head>
<body>
<div id="main">
    <div class="content-block-title">Conditions de ski</div>
    <div class="list-block">
    <ul>
        <li>
            <div class="item-content">
                <div class="item-media">
                    <div class="empty-item-media"></div>
                </div>
                <div class="item-inner">
                    <div class="item-title-row">
                        <div class="item-title">Mise &agrave; jour</div>
                    </div>
                    <div id="updated-text" class="item-subtitle">&nbsp;</div>
                    <div id="updated-text-2" class="item-text"></div>
                </div>
            </div>
        </li>
        <li>
            <div class="item-content">
                <div class="item-media">
                    <div class="empty-item-media"></div>
                </div>
                <div class="item-inner">
                    <div class="item-title-row">
                        <div class="item-title">Fart suggéré</div>
                    </div>
                    <div id="wax-text" class="item-subtitle">&nbsp;</div>
                    <div id="snow-text" class="item-text"></div>
                </div>
            </div>
        </li>
        <li>
            <div class="item-content">
                <div class="item-media">
                    <div class="empty-item-media"></div>
                </div>
                <div class="item-inner">
                    <div class="item-title-row">
                        <div class="item-title">Observations</div>
                    </div>
                    <div id="obs-text" class="item-subtitle">&nbsp;</div>
                    <div id="forecast-a-text" class="item-text"></div>
                    <div id="forecast-b-text" class="item-text"></div>
                </div>
            </div>
        </li>
        <li>
            <div class="item-content">
                <div class="item-media">
                    <div class="empty-item-media"></div>
                </div>
                <div class="item-inner">
                    <div class="item-title-row">
                        <div class="item-title">Soleil</div>
                    </div>
                    <div id="lever-coucher-text" class="item-subtitle">&nbsp;</div>
                    <div id="semaine-text" class="item-text"></div>
                </div>
            </div>
        </li>
        <li>
            <div class="item-content">
                <div class="item-media">
                    <div class="empty-item-media"></div>
                </div>
                <div class="item-inner">
                    <div class="item-title-row">
                        <div class="item-title">Neige au P8</div>
                    </div>
                    <div id="p8-text" class="item-subtitle">&nbsp;</div>
                    <div id="new24-text" class="item-text"></div>
                </div>
            </div>
        </li>
    </ul>
    </div>
</div>
</body>
</html>
